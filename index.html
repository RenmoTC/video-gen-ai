<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Bot ‚Ä¢ n8n</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0b0b; color:#fff; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; }
    .wrap { min-height:100vh; display:grid; place-items:center; padding:24px; }
    .chat { width:min(900px, 96vw); background:#121212; border:1px solid #1f1f1f; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column; overflow:hidden; }
    header { display:flex; align-items:center; gap:10px; padding:14px 16px; border-bottom:1px solid #222; background:#151515; position:sticky; top:0; z-index:1; }
    header h1 { font-size:16px; margin:0; opacity:.9 }
    .thread { padding:18px; display:flex; flex-direction:column; gap:12px; overflow:auto; max-height: calc(100vh - 240px); }
    .bubble { max-width:84%; padding:12px 14px; border-radius:14px; line-height:1.4; word-wrap:break-word; }
    .user { background:#1f2937; margin-left:auto; border:1px solid #263041; }
    .assistant { background:#18181b; border:1px solid #23232a; }
    .composer { display:flex; gap:10px; padding:14px; border-top:1px solid #222; background:#151515; }
    .composer input { flex:1; padding:14px 16px; border-radius:12px; background:#0e0e0e; color:#fff; border:1px solid #2a2a2a; }
    .composer button { padding:14px 16px; border-radius:12px; border:1px solid #3a3a3a; background:#0f62fe; color:#fff; cursor:pointer; }

    .typing { display:inline-flex; gap:6px; align-items:center; }
    .typing span { width:8px; height:8px; border-radius:50%; background:#9ca3af; display:inline-block; animation:bounce 1.2s infinite; }
    .typing span:nth-child(2){ animation-delay:.15s }
    .typing span:nth-child(3){ animation-delay:.3s }
    @keyframes bounce { 0%,80%,100% { transform:translateY(0); opacity:.5 } 40% { transform:translateY(-5px); opacity:1 } }

    video { width:100%; height:auto; border-radius:12px; display:block; }
    .videoCard { padding:10px; background:#0f0f10; border:1px solid #23232a; border-radius:12px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:8px; }
    .dl { background:#0e0e0e; color:#e5e7eb; border:1px solid #2a2a2a; padding:8px 12px; border-radius:10px; text-decoration:none; }
    .hint { opacity:.7; text-align:center; padding:20px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="chat">
      <header>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#7dd3fc"><path d="M12 2l3 7h7l-5.5 4 2 7-6.5-4.5L5.5 20l2-7L2 9h7l3-7z"/></svg>
        <h1>Video Bot</h1>
      </header>
      <div id="thread" class="thread">
        <div class="hint">Type a prompt to generate a video. It will appear below with a download button.</div>
      </div>
      <form id="form" class="composer">
        <input id="prompt" placeholder="e.g., man surfing at sunrise" autocomplete="off" required />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script>
    // üîó Set this to your n8n Webhook (Trigger) Production URL
    const N8N_WEBHOOK_URL = 'https://3d0762247002.ngrok-free.app/webhook/make-video';

    const thread = document.getElementById('thread');
    const form = document.getElementById('form');
    const promptEl = document.getElementById('prompt');

    function addUser(text){
      const b = document.createElement('div');
      b.className = 'bubble user';
      b.textContent = text;
      thread.appendChild(b); thread.scrollTop = thread.scrollHeight;
    }
    function addTyping(){
      const b = document.createElement('div');
      b.className = 'bubble assistant';
      b.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
      thread.appendChild(b); thread.scrollTop = thread.scrollHeight;
      return b; // return element so we can replace it later
    }
    function addError(msg){
      const b = document.createElement('div'); b.className = 'bubble assistant';
      b.textContent = '‚ö†Ô∏è ' + msg; thread.appendChild(b); thread.scrollTop = thread.scrollHeight;
    }
    function addVideo(url){
      const wrap = document.createElement('div'); wrap.className = 'bubble assistant';
      wrap.innerHTML = '<div class="videoCard">\n  <video controls playsinline autoplay src="'+url+'"></video>\n  <div class="row">\n    <a class="dl" href="'+url+'" download>Download MP4</a>\n  </div>\n</div>';
      thread.appendChild(wrap); thread.scrollTop = thread.scrollHeight;
    }

    async function postJSONWithVideo(prompt){
      // POST to n8n; your workflow should respond either with mp4 (binary),
      // a redirect to mp4, or JSON { video_url }
      const res = await fetch(N8N_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      const ct = (res.headers.get('content-type') || '').toLowerCase();

      if (ct.includes('video/mp4')) {
        // n8n streamed the video directly
        const blob = await res.blob();
        return URL.createObjectURL(blob);
      }

      // If server followed a redirect to an mp4, some servers keep generic CT; try blob anyway
      if (res.redirected || res.ok && !ct || (!ct.includes('json') && !ct.includes('text/html'))) {
        try {
          const blob = await res.blob();
          // crude type check: blob size > 1KB => probably a file
          if (blob.size > 1024) return URL.createObjectURL(blob);
        } catch {}
      }

      // JSON path
      if (ct.includes('application/json')) {
        const data = await res.json();
        const url = data.video_url || data.url || data.output;
        if (!url) throw new Error('No video_url in JSON response');
        const vid = await fetch(url);
        const blob = await vid.blob();
        return URL.createObjectURL(blob);
      }

      // HTML path (if your n8n returns an HTML page with a <video>)
      if (ct.includes('text/html')) {
        const html = await res.text();
        // naive extraction of first src in a <video> tag
        const m = html.match(/<video[^>]*src=["']([^"']+)["']/i);
        if (m) {
          const vid = await fetch(m[1]);
          const blob = await vid.blob();
          return URL.createObjectURL(blob);
        }
        throw new Error('Got HTML but no <video> src');
      }

      // Fallback: try to treat as file
      const blob = await res.blob();
      if (blob.size > 0) return URL.createObjectURL(blob);
      throw new Error('Unexpected response type');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = promptEl.value.trim();
      if (!text) return;

      addUser(text);
      promptEl.value = '';
      const typing = addTyping();

      try {
        const url = await postJSONWithVideo(text);
        typing.remove();
        addVideo(url);
      } catch (err) {
        typing.remove();
        addError(err.message || 'Something went wrong');
      }
    });
  </script>
</body>
</html>
